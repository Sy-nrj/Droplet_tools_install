#!/bin/bash

# Usage:
# bash C_Resolve_Subdomains.sh input/targets.txt

set -e

INPUT=$1
if [ -z "$INPUT" ]; then
    echo "[-] Usage: $0 <target_list.txt | single_domain>"
    exit 1
fi

# Get resolvers
RESOLVERS="resolvers.txt"
curl -s https://raw.githubusercontent.com/trickest/resolvers/main/resolvers.txt -o "$RESOLVERS"

# Determine if input is a file or domain
if [ -f "$INPUT" ]; then
    TARGETS=$(cat "$INPUT")
else
    TARGETS="$INPUT"
fi

for domain in $TARGETS; do
    echo "[*] Resolving subdomains for $domain"

    SUBS_FILE="output/subdomains/$domain/subdomains/all_subs.txt"
    if [ ! -f "$SUBS_FILE" ]; then
        echo "[-] Missing subdomain file for $domain: $SUBS_FILE"
        continue
    fi

    TARGET_RESOLVED_DIR="output/subdomains/$domain/resolved"
    mkdir -p "$TARGET_RESOLVED_DIR"

    # Run dnsx
    dnsx -l "$SUBS_FILE" -silent -resolvers "$RESOLVERS" \
        -o "$TARGET_RESOLVED_DIR/dnsx_resolved.txt"

    # Run puredns
    puredns resolve "$SUBS_FILE" --resolvers "$RESOLVERS" \
        --write "$TARGET_RESOLVED_DIR/puredns_resolved.txt" --quiet

    # Run massdns
    MASSDNS_OUT="$TARGET_RESOLVED_DIR/massdns.txt"
    massdns -r "$RESOLVERS" -t A -o S -w "$MASSDNS_OUT" "$SUBS_FILE"

    # Extract unique resolved domains
    cat "$TARGET_RESOLVED_DIR/dnsx_resolved.txt" \
        "$TARGET_RESOLVED_DIR/puredns_resolved.txt" \
        <(cut -d ' ' -f1 "$MASSDNS_OUT") \
        | sort -u > "$TARGET_RESOLVED_DIR/resolved.txt"

    # Extract IPs
    cut -d ' ' -f3 "$MASSDNS_OUT" | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' \
        | sort -u > "$TARGET_RESOLVED_DIR/ips.txt"

    # Run port scan with masscan
    echo "[*] Running port scan on resolved IPs for $domain"
    MASSCAN_OUT="$TARGET_RESOLVED_DIR/all_ports_masscan.txt"
    if [ -s "$TARGET_RESOLVED_DIR/ips.txt" ]; then
        masscan -p1-65535 -iL "$TARGET_RESOLVED_DIR/ips.txt" --rate=1000 -oG "$MASSCAN_OUT"
    else
        echo "[!] No IPs found to scan for $domain"
    fi

    echo "[✓] Resolution and scanning complete for $domain"
done

echo "[✓] All targets processed."
